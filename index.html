<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSKF - কুপতলা আলোকিত সমাজ ফাউন্ডেশন</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&family=Playfair+Display:wght@700;900&family=Montserrat:wght@400;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background: #f1f5f9; color: #1e293b; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .premium-card { background: white; border-radius: 2rem; box-shadow: 0 20px 40px -15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03); transition: all 0.3s ease; }
        .section-hide { display: none; }
        .btn-premium { background: linear-gradient(135deg, #059669, #047857); color: white; box-shadow: 0 10px 20px rgba(5, 150, 105, 0.2); }
        
        /* Certificate Styles */
        #certificateTemplate { width: 1200px; height: 850px; background: #fff; position: fixed; left: -9999px; font-family: 'Montserrat', sans-serif; color: #1a2e35; }
        .cert-outer-border { height: 100%; width: 100%; background: #064e3b; padding: 25px; position: relative; }
        .cert-inner-border { height: 100%; width: 100%; background: #fff; border: 4px solid #d4af37; position: relative; display: flex; flex-direction: column; align-items: center; padding: 40px; background-image: radial-gradient(#d4af37 0.3px, transparent 0.3px); background-size: 15px 15px; }
        .cert-watermark { position: absolute; font-size: 150px; color: rgba(212, 175, 55, 0.05); font-weight: 900; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); pointer-events: none; z-index: 0; }
        .cert-content { position: relative; z-index: 1; width: 100%; text-align: center; }
        .cert-member-name { font-family: 'Playfair Display', serif; font-size: 50px; font-weight: 900; color: #064e3b; margin: 10px 0; border-bottom: 2px solid #d4af37; display: inline-block; padding: 0 30px; }
        .cert-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%; margin: 20px auto; text-align: left; background: rgba(241, 245, 249, 0.5); padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; }
        .detail-item { font-size: 14px; font-weight: 600; color: #475569; }
        .detail-item span { color: #0f172a; font-weight: 800; }
        .cert-trademark-seal { width: 120px; height: 120px; position: absolute; bottom: 60px; left: 100px; transform: rotate(-10deg); filter: sepia(1) saturate(5) hue-rotate(10deg); opacity: 0.8; }
        .cert-signature { position: absolute; bottom: 60px; right: 100px; text-align: center; }
        .sign-font { font-family: 'Dancing Script', cursive; font-size: 32px; color: #064e3b; border-bottom: 1px solid #1e293b; padding: 0 20px; }
        
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { animation: marquee 25s linear infinite; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-nav px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4 cursor-pointer" onclick="showSection('home')">
            <!-- লোগো সাইজ বাড়িয়ে w-16 করা হয়েছে এবং ফ্রেমের সাথে ম্যাচ করা হয়েছে -->
            <div class="relative w-16 h-16 rounded-full border-4 border-emerald-500 overflow-hidden shadow-xl bg-white">
                <img src="https://i.ibb.co.com/sJkNZHQL/IMG-20260220-072042.jpg" alt="BSKF Logo" class="w-full h-full object-cover">
            </div>
            <div class="flex flex-col">
                <span class="text-xl font-black tracking-tighter text-slate-900 leading-none">BSKF</span>
                <span class="text-xs font-bold text-emerald-600 italic">Foundation.</span>
            </div>
        </div>
        <div class="relative">
            <button id="profileBtn" class="bg-white border p-2 rounded-2xl shadow-sm hover:ring-2 ring-emerald-500 transition-all">
                <i data-lucide="user" class="w-6 h-6 text-slate-600"></i>
            </button>
            <div id="profileMenu" class="hidden absolute right-0 mt-3 w-56 bg-white rounded-3xl shadow-2xl border p-2 z-50">
                <div id="guestLinks">
                    <button onclick="showSection('login')" class="w-full text-left px-5 py-3 hover:bg-slate-50 rounded-2xl font-bold text-sm">লগইন</button>
                    <button onclick="showSection('register')" class="w-full text-left px-5 py-3 hover:bg-emerald-50 rounded-2xl font-bold text-sm text-emerald-600">নিবন্ধন</button>
                </div>
                <div id="userLinks" class="hidden">
                    <button onclick="showSection('dashboard')" class="w-full text-left px-5 py-3 hover:bg-slate-50 rounded-2xl font-bold text-sm">ড্যাশবোর্ড</button>
                    <button onclick="logout()" class="w-full text-left px-5 py-3 hover:bg-red-50 text-red-600 rounded-2xl font-bold text-sm mt-1 border-t">লগআউট</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-6 space-y-10">
        
        <!-- Home Section -->
        <section id="home">
            <header class="text-center py-10 space-y-3">
                <h1 class="text-5xl md:text-7xl font-black tracking-tighter italic uppercase text-slate-900">BSKF <span class="text-emerald-600">FOUNDATION</span></h1>
                <p class="text-slate-500 font-medium text-lg">বন্ধুমহল সমাজ কল্যাণ ফাউন্ডেশন - মানবতার কল্যাণে।</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="premium-card p-8 border-b-4 border-emerald-500 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Fund</p>
                    <h3 id="statFund" class="text-3xl font-black text-emerald-700">৳ ০</h3>
                </div>
                <div class="premium-card p-8 border-b-4 border-rose-500 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Expense</p>
                    <h3 id="statExpense" class="text-3xl font-black text-rose-700">৳ ০</h3>
                </div>
                <div class="premium-card p-8 border-b-4 border-blue-500 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Active Members</p>
                    <h3 id="statMembers" class="text-3xl font-black text-blue-700">০ জন</h3>
                </div>
            </div>

            <div class="bg-slate-900 py-4 rounded-3xl overflow-hidden shadow-xl mb-10">
                <div id="ticker" class="flex gap-20 animate-marquee whitespace-nowrap text-white text-[11px] font-bold uppercase tracking-widest"></div>
            </div>

            <div class="premium-card p-8 mb-12">
                <h4 class="text-lg font-black mb-6 flex items-center gap-2 italic"><i data-lucide="activity" class="text-emerald-500"></i> সাম্প্রতিক ব্যয়সমূহ</h4>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="homeExpList" class="divide-y"></tbody></table></div>
            </div>
        </section>

        <!-- Register Section -->
        <section id="register" class="section-hide max-w-2xl mx-auto">
            <div class="premium-card p-8 md:p-12">
                <h2 class="text-3xl font-black mb-2 text-center italic">সদস্য আবেদন ফরম</h2>
                <p class="text-center text-rose-500 text-xs font-bold mb-8 uppercase tracking-widest">Registration Fee: 200 BDT</p>
                
                <form id="regForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="regName" placeholder="আপনার পূর্ণ নাম" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="text" id="regFather" placeholder="পিতার নাম" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="text" id="regMother" placeholder="মাতার নাম" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="text" id="regNID" placeholder="এনআইডি নম্বর" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="text" id="regPhone" placeholder="মোবাইল নম্বর" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="password" id="regPass" placeholder="পাসওয়ার্ড তৈরি করুন" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <input type="text" id="regVillage" placeholder="গ্রাম" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="text" id="regThana" placeholder="থানা" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="text" id="regDistrict" placeholder="জেলা" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                        <input type="number" id="regWard" placeholder="ওয়ার্ড নং" class="p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                    </div>
                    
                    <div class="bg-emerald-50 p-6 rounded-[2rem] border-2 border-dashed border-emerald-200 space-y-4">
                        <div class="pay-numbers flex flex-wrap justify-center gap-4 text-[10px] font-black text-emerald-800 uppercase italic"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <select id="regMethod" class="p-4 bg-white rounded-xl border font-bold text-sm" required>
                                <option value="">Method</option><option value="Bkash">Bkash</option><option value="Nagad">Nagad</option>
                            </select>
                            <input type="text" id="regSender" placeholder="Sender Number" class="p-4 bg-white rounded-xl border font-bold text-sm" required>
                        </div>
                        <input type="text" id="regTrx" placeholder="Transaction ID (TrxID)" class="w-full p-4 bg-white rounded-xl border-2 border-emerald-400 font-black text-center uppercase tracking-widest" required>
                    </div>
                    <button type="submit" class="w-full btn-premium py-5 rounded-2xl font-black text-lg uppercase">Apply for Membership</button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section-hide space-y-8">
            <div id="pendingStatus" class="hidden bg-amber-50 border-2 border-dashed border-amber-200 p-10 rounded-[3rem] text-center">
                <i data-lucide="loader" class="w-12 h-12 text-amber-500 mx-auto mb-4 animate-spin"></i>
                <h3 class="text-xl font-black text-amber-700">আবেদনটি যাচাই করা হচ্ছে...</h3>
                <p class="text-xs font-bold text-slate-500 mt-2">অ্যাডমিন আপনার পেমেন্ট নিশ্চিত করলে আইডি সক্রিয় হবে।</p>
            </div>

            <div id="activeDashboard" class="hidden space-y-10">
                <div class="premium-card p-12 text-center relative overflow-hidden bg-white border-t-8 border-emerald-600">
                    <div class="bg-emerald-600 text-white absolute top-6 right-[-35px] px-12 py-1 rotate-45 text-[10px] font-black shadow-lg uppercase">Official Member</div>
                    <h4 id="dashName" class="text-4xl font-black text-slate-900 mb-1 italic uppercase tracking-tighter">...</h4>
                    <p id="dashID" class="text-[11px] text-slate-400 font-black tracking-[0.4em] uppercase mb-10">BSKF-0000</p>
                    
                    <button onclick="downloadCertificate()" id="downloadBtn" class="bg-slate-900 text-white px-10 py-4 rounded-full font-black text-[12px] uppercase tracking-widest flex items-center gap-3 mx-auto shadow-2xl hover:bg-emerald-600 transition-all active:scale-95">
                        <i data-lucide="award" class="w-5 h-5"></i> Get Membership Certificate
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <button onclick="showSection('payment')" class="bg-emerald-600 text-white p-8 rounded-[2.5rem] flex flex-col items-center gap-3 shadow-xl font-black italic">
                        <i data-lucide="plus-circle"></i> অর্থ জমা দিন
                    </button>
                    <button onclick="showSection('history')" class="bg-white text-slate-900 p-8 rounded-[2.5rem] flex flex-col items-center gap-3 shadow-md border font-black italic">
                        <i data-lucide="history"></i> পেমেন্ট রেকর্ড
                    </button>
                </div>
            </div>
        </section>

        <!-- Ultra Premium Certificate Template -->
        <div id="certificateTemplate">
            <div class="cert-outer-border">
                <div class="cert-inner-border">
                    <div class="cert-watermark">BSKF</div>
                    <div class="cert-content">
                        <div class="flex justify-center mb-4">
                            <!-- সার্টিফিকেটের লোগো সাইজ ও ফিক্স -->
                            <img src="https://i.ibb.co.com/sJkNZHQL/IMG-20260220-072042.jpg" crossorigin="anonymous" alt="Logo" class="w-40 h-40 rounded-full border-4 border-yellow-500 shadow-2xl object-cover">
                        </div>
                        <h1 style="font-size: 50px; color: #064e3b; font-weight: 900; letter-spacing: -1px;">BSKF FOUNDATION</h1>
                        <p style="font-size: 16px; font-weight: 700; color: #b45309; letter-spacing: 5px; margin-bottom: 30px; text-transform: uppercase;">Certificate of Official Membership</p>
                        
                        <p style="font-size: 18px; color: #64748b; font-style: italic;">This is to certify that</p>
                        <div class="cert-member-name" id="certName">MEMBER NAME</div>
                        
                        <div class="cert-details-grid">
                            <div class="detail-item">Father's Name: <span id="certFather">...</span></div>
                            <div class="detail-item">Mother's Name: <span id="certMother">...</span></div>
                            <div class="detail-item">NID Number: <span id="certNID">...</span></div>
                            <div class="detail-item">Ward No: <span id="certWard">...</span></div>
                            <div class="detail-item">Village: <span id="certVillage">...</span></div>
                            <div class="detail-item">Thana: <span id="certThana">...</span></div>
                            <div class="detail-item">District: <span id="certDistrict">...</span></div>
                            <div class="detail-item">Member ID: <span id="certID">BSKF-0000</span></div>
                        </div>

                        <p style="width: 70%; margin: 20px auto; font-size: 14px; line-height: 1.6; font-weight: 500; color: #475569;">
                            Is a registered and verified member of Kuptola Alokito Somaj Foundation (BSKF). We acknowledge their commitment towards humanity and social welfare.
                        </p>
                    </div>

                    <!-- Seal with Logo -->
                    <img src="https://i.ibb.co.com/sJkNZHQL/IMG-20260220-072042.jpg" crossorigin="anonymous" class="cert-trademark-seal rounded-full object-cover">

                    <!-- Admin Signature -->
                    <div class="cert-signature">
                        <div class="sign-font">Alphas</div>
                        <p style="font-size: 12px; font-weight: 900; margin-top: 5px; color: #1e293b;">FOUNDER & ADMIN</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Section -->
        <section id="login" class="section-hide max-w-sm mx-auto py-10">
            <div class="premium-card p-10">
                <h2 class="text-2xl font-black mb-8 text-center italic uppercase">Member Login</h2>
                <form id="loginForm" class="space-y-4">
                    <input type="text" id="logPhone" placeholder="মোবাইল নম্বর" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold outline-none" required>
                    <input type="password" id="logPass" placeholder="পাসওয়ার্ড" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold outline-none" required>
                    <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase hover:bg-emerald-600 transition-all">Login Now</button>
                </form>
            </div>
        </section>

        <!-- Payment Section -->
        <section id="payment" class="section-hide max-w-md mx-auto">
            <div class="premium-card p-10">
                <h3 class="text-xl font-black mb-8 italic uppercase text-center">মাসিক চাঁদা প্রদান</h3>
                <div class="pay-numbers bg-slate-900 text-emerald-400 p-6 rounded-3xl mb-8 space-y-2 text-[11px] font-bold text-center border-b-4 border-emerald-600"></div>
                <form id="payForm" class="space-y-4">
                    <select id="pMethod" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                        <option value="">Select Method</option><option value="Bkash">Bkash</option><option value="Nagad">Nagad</option>
                    </select>
                    <input type="number" id="pAmt" placeholder="পরিমাণ (৳)" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                    <input type="text" id="pTrx" placeholder="TrxID" class="w-full p-4 bg-slate-50 rounded-2xl border font-black uppercase tracking-widest" required>
                    <input type="text" id="pFrom" placeholder="প্রেরক নম্বর" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                    <button type="submit" class="w-full btn-premium py-4 rounded-2xl font-black uppercase">Submit Payment</button>
                </form>
            </div>
        </section>

        <!-- History Section -->
        <section id="history" class="section-hide max-w-md mx-auto space-y-4 pb-20">
            <h3 class="text-xl font-black italic mb-6">আপনার পেমেন্ট রেকর্ড</h3>
            <div id="histList" class="space-y-4"></div>
        </section>

    </main>

    <script>
        // Firebase Config
        const firebaseConfig = {
  apiKey: "AIzaSyC4e8beeMrxnOU0azJtnwMpduvf6LMfwZs",
  authDomain: "bskf-9ca59.firebaseapp.com",
  projectId: "bskf-9ca59",
  storageBucket: "bskf-9ca59.firebasestorage.app",
  messagingSenderId: "94830736952",
  appId: "1:94830736952:web:e285f0bcc40e87cca598cd",
  measurementId: "G-CE5EH5N2S6"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        lucide.createIcons();

        let activeUser = null;

        function showSection(id) {
            ['home', 'register', 'login', 'dashboard', 'payment', 'history'].forEach(s => {
                const el = document.getElementById(s); if(el) el.classList.add('section-hide');
            });
            document.getElementById(id).classList.remove('section-hide');
            document.getElementById('profileMenu').classList.add('hidden');
            window.scrollTo(0,0);
        }

        document.getElementById('profileBtn').onclick = (e) => { e.stopPropagation(); document.getElementById('profileMenu').classList.toggle('hidden'); }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const phone = user.email.split('@')[0];
                db.collection("members").doc(phone).onSnapshot(doc => {
                    if(doc.exists) { activeUser = doc.data(); updateDashboardUI(); }
                });
            } else { showSection('home'); }
        });

        function updateDashboardUI() {
            if(!activeUser) return;
            document.getElementById('dashName').innerText = activeUser.name;
            document.getElementById('dashID').innerText = 'ID: BSKF-' + activeUser.id;
            
            // Map data to Certificate
            document.getElementById('certName').innerText = activeUser.name;
            document.getElementById('certFather').innerText = activeUser.fatherName;
            document.getElementById('certMother').innerText = activeUser.motherName;
            document.getElementById('certNID').innerText = activeUser.nid;
            document.getElementById('certVillage').innerText = activeUser.village;
            document.getElementById('certThana').innerText = activeUser.thana;
            document.getElementById('certDistrict').innerText = activeUser.district;
            document.getElementById('certWard').innerText = activeUser.ward;
            document.getElementById('certID').innerText = 'BSKF-' + activeUser.id;

            document.getElementById('guestLinks').classList.add('hidden');
            document.getElementById('userLinks').classList.remove('hidden');

            if(activeUser.status === 'pending') {
                document.getElementById('pendingStatus').classList.remove('hidden');
                document.getElementById('activeDashboard').classList.add('hidden');
            } else {
                document.getElementById('pendingStatus').classList.add('hidden');
                document.getElementById('activeDashboard').classList.remove('hidden');
                loadPersonalHistory(activeUser.phone);
            }
        }

        function initApp() {
            db.collection("stats").doc("summary").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('statFund').innerText = '৳ ' + (d.fund || 0).toLocaleString('bn-BD');
                    document.getElementById('statExpense').innerText = '৳ ' + (d.expenses || 0).toLocaleString('bn-BD');
                }
            });

            db.collection("members").where("status", "==", "active").onSnapshot(snap => {
                document.getElementById('statMembers').innerText = snap.size.toLocaleString('bn-BD') + ' জন';
                const ticker = document.getElementById('ticker'); ticker.innerHTML = "";
                snap.forEach(m => ticker.innerHTML += `<span>★ ${m.data().name} (${m.data().role || 'সদস্য'})</span>`);
            });

            db.collection("expenses").onSnapshot(snap => {
                const list = document.getElementById('homeExpList'); list.innerHTML = "";
                snap.forEach(doc => {
                    const e = doc.data();
                    list.innerHTML += `<tr><td class="py-4 font-bold text-slate-700 uppercase italic">${e.desc}</td><td class="py-4 text-rose-600 font-black">৳ ${e.amount}</td></tr>`;
                });
            });

            db.collection("config").doc("payment_numbers").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    const numHTML = `<span>BKASH: ${d.bkash}</span> | <span>NAGAD: ${d.nagad}</span>`;
                    document.querySelectorAll('.pay-numbers').forEach(el => el.innerHTML = numHTML);
                }
            });
        }

        async function downloadCertificate() {
            const btn = document.getElementById('downloadBtn'); btn.innerText = 'Generating Certificate...';
            const template = document.getElementById('certificateTemplate');
            
            html2canvas(template, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: false,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `BSKF_Certificate_${activeUser.name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.innerHTML = '<i data-lucide="award"></i> Get Membership Certificate';
                lucide.createIcons();
            }).catch(err => {
                console.error("Canvas error:", err);
                alert("সার্টিফিকেট তৈরিতে সমস্যা হয়েছে। আবার চেষ্টা করুন।");
                btn.innerHTML = '<i data-lucide="award"></i> Get Membership Certificate';
            });
        }

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const phone = document.getElementById('regPhone').value;
            const trx = document.getElementById('regTrx').value;
            try {
                await auth.createUserWithEmailAndPassword(phone + "@bksf.com", document.getElementById('regPass').value);
                const memberInfo = { 
                    name: document.getElementById('regName').value, 
                    fatherName: document.getElementById('regFather').value,
                    motherName: document.getElementById('regMother').value,
                    nid: document.getElementById('regNID').value,
                    village: document.getElementById('regVillage').value,
                    thana: document.getElementById('regThana').value,
                    district: document.getElementById('regDistrict').value,
                    ward: document.getElementById('regWard').value,
                    phone: phone, 
                    id: Math.floor(1000 + Math.random() * 9000), 
                    status: 'pending', 
                    role: 'member', 
                    reg_trx: trx 
                };
                await db.collection("members").doc(phone).set(memberInfo);
                await db.collection("payments").add({ phone, name: memberInfo.name, amount: 200, trxId: trx, method: document.getElementById('regMethod').value, from: document.getElementById('regSender').value, status: 'pending', type: 'registration', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                alert("নিবন্ধন আবেদন সফল হয়েছে! অ্যাডমিন ভেরিফিকেশনের জন্য অপেক্ষা করুন।");
                showSection('dashboard');
            } catch (err) { alert(err.message); }
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            try { await auth.signInWithEmailAndPassword(document.getElementById('logPhone').value + "@bksf.com", document.getElementById('logPass').value); showSection('dashboard'); }
            catch (err) { alert("ভুল তথ্য অথবা একাউন্ট নেই!"); }
        };

        document.getElementById('payForm').onsubmit = async (e) => {
            e.preventDefault();
            await db.collection("payments").add({ phone: activeUser.phone, name: activeUser.name, method: document.getElementById('pMethod').value, amount: parseFloat(document.getElementById('pAmt').value), trxId: document.getElementById('pTrx').value, from: document.getElementById('pFrom').value, status: 'pending', type: 'monthly', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            alert("পেমেন্ট তথ্য জমা হয়েছে!"); showSection('history'); e.target.reset();
        };

        function loadPersonalHistory(phone) {
            db.collection("payments").where("phone", "==", phone).onSnapshot(snap => {
                const list = document.getElementById('histList'); list.innerHTML = "";
                let pDocs = []; snap.forEach(d => pDocs.push(d.data()));
                pDocs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).forEach(data => {
                    const isOk = data.status === 'confirmed';
                    list.innerHTML += `<div class="bg-white p-6 rounded-3xl border flex justify-between items-center shadow-sm"><div><p class="text-xl font-black italic">৳ ${data.amount}</p><p class="text-[9px] text-slate-400 font-bold uppercase">${data.method} • ${data.trxId}</p></div><span class="px-3 py-1 rounded-full text-[9px] font-black uppercase italic ${isOk ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}">${isOk ? 'Success' : 'Pending'}</span></div>`;
                });
            });
        }

        function logout() { auth.signOut(); location.reload(); }
        initApp();
    </script>
</body>
</html>
